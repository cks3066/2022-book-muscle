# P388 ~ P401

함수를 일급 객체로 취급하는 함수형 프로그래밍 언어에서 사용되는 이 클로저는 그리 어렵지 않습니다 !!

> 클로저는 함수와 그 함수가 선언되어있는 렉시컬 환경과의 조합이다.

```jsx
function outer() {
  const x = 1;
  function inner() {
    console.log(x); // 1
  }
  inner();
}
outer();
```

inner의 상위 스코프는 outer의 함수 스코프이다. 그렇기 때문에 중첩함수 inner는 외부 스코프에 정의된 x 변수에 접근할 수 있다.

자바스크립트는 렉시컬 스코프을 따르기 때문에 (호출된 곳이 아닌 자신이 선언된 곳에서의 스코프를 따른다.)

```jsx
const x = 1;
function outer() {
  const x = 10;
  inner();
}
function inner() {
  console.log(x); // 1
}
outer();
```

위와 같은 결과를 보이게 된다.

## 1. 렉시컬 스코프란 ??

자바스크립트 엔진은 어디서 호출했는지가 아니라 함수를 어디에 정의했는지에 따라 상위 스코프를 결정한다. -> 정적스코프(렉시컬 스코프)라 부른다.

**스코프의 실체는 실행 컨텍스트의 렉시컬 환경이다.** 이 렉시컬 환경은 자신의 `외부 렉시컬 환경에 대한 참조`를 통해 상위 렉시컬 환경과 연결된다. -> 이를 스코프 체인이라 부른다.

렉시컬 환경의 `외부 렉시컬 환경에 대한 참조` 값은 함수 정의가 평가되는 시점에 함수가 정의된 환경에 의해 결정된다. 이것이 바로 **렉시컬 스코프**이다.

## 2. 함수 객체의 내부 슬롯

정의된 환경과 호출된 환경은 다를 수 있습니다. 따라서 렉시컬 스코프가 가능하려면 자신이 호출되는 환경과는 상관없이 자신이 정의된 환경을 (상위 스코프)를 기억해야합니다. 함수는 자신의 내부 슬롯 `Environment`에 자신이 정의된 환경에 대한 참조를 저장합니다.

**자신이 정의된 환경에 대한 참조를 함수 객체의 내부 슬롯에 저장한다.(현재 실행 중인 실행 컨텍스트의 렉시컬 환경을 가리킨다)**

**함수 객체는 상위 스코프의 실행 컨텍스트가 실행 중일때 생성되며(혹은 상위 스코프 소스코드 평가 시점에), 생성될 때 실행 중인 실행 컨텍스트가 함수 객체의 내부슬롯에 저장되는 참조 값이다.**

자신이 존재하는 한 상위 스코프를 기억한다!!

```jsx
const x = 1;

// foo 함수 객체는 자신의 상위 스코프인 전역 렉시컬 환경 참조 값을 Environment에 저장한다.
function foo() {
  const x = 10;

  bar();
}

// bar 함수 객체는 자신의 상위 스코프인 전역 렉시컬 환경 참조 값을 Environment에 저장한다.
function bar() {
  console.log(x); // 1
}

foo(); // 1
bar(); // 1
```

위 코드는 다음 사진과 같이 설명된다.

<img src="./assets/함수객체와렉시컬환경.jpeg" />

### Q1. 사진을 보고 의아한 점

실행컨텍스트에서 자신이 선언된 위치에서의 상위 스코프 (상위 실행컨텍스트가 가리키는 렉시컬 환경)을 참조할 수 있는데 굳이 함수 객체에 `Environment`에도 상위 스코프 참조값을 저장해야하는가 ?

### Q2. 함수 정의가 평가되는 시점 (전역 코드가 평가되는 시점에) 실행 중인 실행 컨텍스트의 렉시컬 환경인 전역 렉시컬 환경의 참조가 저장된다.

함수가 호출되면, 함수 내부로 제어권이 이동한다. 그리곤 함수 코드를 평가하기 시작하는데, 아래 순서로 진행된다. (복습)

1. 함수 실행 컨텍스트가 생성된다.
2. 함수 렉시컬 환경이 생성된다. (함수 환경 레코드 + this 바인딩 + 외부 렉시컬 환경에 대한 참조값 저장)

외부 렉시컬 환경에 대한 참조 값을 저장할 때, 함수 객체가 갖는 Environment 내부 슬롯의 값을 가져와 저장한다. 결국 바로 함수가 정의된 곳의 상위 스코프가 저장되며, 이 것이 바로 함수 정의 위치에 따라 상위 스코프를 결정하는 렉시컬 스코프의 실체이다.

## 3. 클로저와 렉시컬 환경

```jsx
const x = 1;

function outer() {
  const x = 10;
  const inner = function () {
    console.log(x); // 10
  };
  return inner;
}
const inner = outer();
inner();
```

outer 함수는 중첩 함수 inner를 반환하고 생명 주기를 마감한다. (실행 컨텍스트 스택에서 제거된다) 하지만 `inner` 함수에 의해 생명 주기가 종료된 함수 내부의 지역 변수에 접근이 가능하다.

**이 처럼 외부 함수보다 중첩함수가 더 오래 유지되는 경우 중첩 함수는 이미 생명 주기가 종료한 외부 함수의 변수를 참조할 수 있다. -> 이러한 중첩함수를 클로저라고 한다.**

outer 함수의 실행 컨텍스트가 종료된다고 해서 outer 함수의 렉시컬 환경까지 소멸하는 것은 아니다!!!

`inner`가 렉시컬 환경을 가리키고 있으므로 가비지 컬렉터에 의해 사라지지 않는다.

<img src="./assets/렉시컬환경과 클로저.jpeg"/>

여기서 `inner` 함수를 호출하면 다음과 같은 그림이 된다.

<img src="./assets/inner.jpeg">

**결국 Inner함수는 외부함수보다 오래 생존했고, 외부 함수의 내부 변수들의 값을 변경할 수도 있고 참조할수도있다.**

1. 중첩함수이지만, 외부함수보다 일찍 소멸하는 경우 클로저가 아니다.

2. 중첩함수이지만, 상위 스코프의 어떤 식별자도 참조하지 않는다면 이는 클로저가 아니다.

3. 중첩함수가 외부 함수보다 오래 유지되고, 상위 스코프의 식별자를 참조하고 있으면 클로저다.

**일반적으로 클로저는 중첩함수가 상위 스코프의 식별자를 참조하고, 외부 함수보다 오래 유지되는 경우로 한정된다**
